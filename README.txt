
  DOSVAXJ3

●概要
　DOSBox 派生版の DOSVAX を元に作成した AX & J-3100 & DOS/V Emulator です。
　東芝 DOS or PC-DOS/V or MS-DOS/V、J-3100 or DOS/V 用 FEP、FONTX2 形式のフォ
ントファイル、Visual C++ のランタイム等は不要です。フォントファイルを使用して
画面を実機に近づける事も可能です。
　日本語キーボードに対応しています。
　Windows の IME、Linux の XIM を使用して日本語入力ができます。
　Wengier Wu 氏による DOSBox-lfn の修正を取り込み、ロングファイルネームや画面
上の文字のクリップボードへのコピー等に対応しています。

●dosboxj.conf の設定
　Windows の場合、dosboxj.exe と同じフォルダの dosboxj.conf を読み込みますが、
存在しない場合 %APPDATA%\DOSBoxJ\dosboxj.conf を作成し、それを使用します。
　Linux の場合 ~/.dosboxj/dosboxj.conf を読み込みます。存在しない場合は
~/.dosboxj/dosboxj.conf を作成し、それを使用します。

・[sdl] セクション
clipboardmodifier  クリップボードのコピー・ペーストの指定をします。
                   none の場合、右クリックでペースト、右ドラッグで選択開始し、
                   右ボタンオフで選択範囲の文字がクリップボードにコピーされま
                   す。
                   alt, lalt, ralt の場合は ALT キーを押しながらの右ボタン操作
                   となります。lalt は左 ALT のみ、ralt は右 ALT のみとなりま
                   す。
                   disable の場合は使用しません。
                   Linux の場合、xclip をインストールしておけば使用可能です。

・[dosbox] セクション
machine        dcga を指定すると J-3100 モードで起動します。
               dosv を指定すると DOS/V モードでビデオカード ET-4000 相当で起動
               します。
               dosv_s3 で DOS/V モードでビデオカード S3 相当で起動します。
               jega を指定すると AX モードで起動します。
               上記以外の場合は DOSBox のそれぞれのモードで起動します。

jfontname      描画に使用する Windows フォント名
               フォントファイル名は Shift JIS で記述してください。
               Windows の場合、IME の変換中文字列の表示フォントの指定にも使用
               されます。
               Linux では使用しません。
jfontsbcs      半角表示用 FONTX2 フォントファイルへのパス サイズ:8×19
jfontsbcs16    半角表示用 FONTX2 フォントファイルへのパス サイズ:8×16
jfontdbcs      全角表示用 FONTX2 フォントファイルへのパス サイズ:16×16
jfontdbcs24    全角表示用 FONTX2 フォントファイルへのパス サイズ:24×24
               ファイルの指定がないサイズは Windows のフォントから取得します。
               半角 8×19 は AX, DOS/V モード用で、J-3100 モードでは使用しませ
               ん。
               Windows の場合フォントファイルは dosboxj.exe と同じフォルダに
               置いてください。
               Linux の場合、フォントファイルは ~/.dosboxj に置いてください。

gaijistart     外字領域の開始コードを指定します。未定義の場合 f040 となります。
gaijiend       外字領域の終了コードを指定します。未定義の場合 f0a3 となります
               最大 100 文字分までしか使用できません。
yen            半角フォントの 7fh に \ が入っている場合 true としてください。

im             IM の有効/無効を指定します。true で有効、false で無効です。

languagejp     日本語メッセージ定義ファイルを指定します。
               内容は Shift JIS で記述する必要があります。
               Windows の場合、dosboxj.exe と同じフォルダのファイルが読み込ま
               れます。japanese.lng が添付されています。
               Linux の場合、make install で /usr/local/share/dosboxj に
               japanese.lng がコピーされ、それを使用します。

j3textcolor    J-3100 の文字色  RRGGBB でそれぞれ 0～ff まで指定できます。
j3backcolor    J-3100 の背景色  RRGGBB でそれぞれ 0～ff まで指定できます。

j3100          J-3100 の機種名を指定します。画面の色とキーボード BIOS のシステ
               ムコードの返値が変わります。
               gt, sgt, gx, sgx, sxp  プラズマディスプレイ風
               gl, sl, ss, gs, sx     青液晶風
               sxw, ez                白液晶風
               zs, zx                 白黒画面
               16 進数を指定した場合、画面の色は変わらず、システムコード値のみ
               変更します。

               j3100 で機種名を指定した場合でも j3textcolor, j3backcolor の指
               定が優先されます。
               j3100, j3textcolor, j3backcolor 全て指定がない場合は、文字色は
               白、背景色は黒となり、システムコードは 0x6a74 となります。

debug          J-3100 用の MS-DOS イメージからブートした際に半角英数字が文字化
               けする場合は debug=true としてブートし、途中で表示される 4 桁の
               アドレス文字列を下の j3sbcsaddress に指定してください。
               詳しくは J-3100 モードでの注意事項を参照してください。
j3sbcsaddress  J-3100 用の半角フォントの開始アドレスを指定します。
               未指定の場合 ca00 となります。

vtext          chev vt で切り替わる V-text モードを指定します。
vtext2         chev vt2 で切り替わる V-text モードを指定します。
               vga     解像度  640× 480  文字  80×30
               svga    解像度  800× 600  文字 100×37
               xga     解像度 1024× 768  文字 128×48
               sxga    解像度 1280×1024  文字 160×64
               xga24   解像度 1024× 768  文字  85×32 24ドットフォント
               sxga24  解像度 1280×1024  文字 106×42 24ドットフォント
               Windows フォントで 24 ドットフォントを代用する場合、あまり綺麗
               ではありませんので、FONTX2 ファイルを使用することを推薦します。

・[dos] セクション
keyboardlayout 日本語キーボードの場合 jp、英語キーボードの場合 none としてくだ
               さい。jp と設定した場合、ファイル jp.kl を読み込みます。
               Windows の場合、dosboxj.exe と同じフォルダのファイルが読み込ま
               れます。jp.kl が添付されています。
               Linux の場合、make install で /usr/local/share/dosboxj に jp.kl
               がコピーされ、それを使用します。

ver            DOS のバージョンを指定します。指定がない場合 7.10 となります。
               起動後に ver set コマンドで変更できます。

lfn            ロングファイルネームの設定を指定します。
               true でロングファイルネーム有効、false で無効、auto は DOS バー
               ジョンが 7 以上でロングファイルネーム有効となります。

automount      オートマウントの設定を行います。
               true でオートマウント有効、false で無効です。
               オートマウント有効の場合、C: [enter] で実 PC 上の C ドライブを
               C:\ にマウントします。
               Linux では使用できません。

autoreload     オートリロード(ディレクトリキャッシュ更新)の設定を行います。
               カレントディレクトリもしくは使用ファイルのドライブのディレクト
               リキャッシュを自動更新します。
               cmd でコマンド入力毎、dos で DOS ファンクションのファイル関連
               実行時、all で両方のタイミングでディレクトリキャッシュの更新を
               行います。false で更新は行いません。

　DOSVAXJ3 関連の初期設定値は下記の通りです。
[sdl]
clipboardmodifier=alt

[dosbox]
languagejp=japanese.lng
machine=dosv
jfontname=ＭＳ 明朝
yen=false
im=true
vtext=svga
vtext2=xga

[dos]
keyboardlayout=jp
ver=7.10
lfn=true
automount=true
autoreload=cmd

●Windows 版起動時オプション
　Windows 版はデフォルトでステータスウインドウ非表示となっています。

オプションなし  ステータスウインドウ非表示
-console        ステータスウインドウ表示

●注意事項
　英語/日本語/日本語(V-Text)/J-3100 の各モードに切り替えるには内蔵コマンドの
chev を使用します。
　chev us で英語モード、chev jp で日本語モード(AX 以外は DOS/V)、chev vt/vt2
で日本語モード(DOS/V V-Text)、chev j3 で J-3100 モードとなります。

　日本語モードの場合、コマンドの応答メッセージや日付表示の並びが日本向けとなり
ます。日本語メッセージはファイル japanese.lng で定義しています。定義されていな
いメッセージは英語のままとなります。

　keyboardlayout=jp の場合、Ctrl+F1 で呼び出される mapper も日本語キーボードの
並びの表示になります。
　JP190621 以前のバージョンで Ctrl+F1 の mapper でキー割り当てを変更している場
合、mapperj.map (Windows の場合 dosboxj.exe と同じフォルダ、Linux の場合
~/.dosboxj にあります)を削除して起動し、再度割り当て直してください。

　MS-DOS 用の FEP を入手するのは困難と思われましたので、Windows の IME, Linux
の XIM を使用可能としています。
　Windows 10 で MS-IME を使用する場合、Windows 10 のバージョンを 1803 以上にアッ
プデートしてください。バージョン1709 以前の MS-IME の場合、$IAS.SYS のファンク
ションによる FEP 制御ができません。
　Windows 8.1 の場合は現行の最新版でも $IAS.SYS のファンクションによる FEP 制
御はできません。ATOK 等、他の IME を使用する事を推薦します。
　Linux の XIM の場合、変換文字列や候補が通常とは異なる表示にはなりますが、入
力自体は可能です。
　日本語キーボード設定かつ DOS 用の IME がインストールされている DOS/V イメー
ジからブートした場合でもキーの表記通りに入力可能ですが、Windows で 半角/全角 
キーを有効にしたい場合、[dosbox] im=false とするか、Ctrl+F1 で呼び出される
mapper で 半角/全角キーの機能を他のキーに割り当ててください。
　Linux で 半角/全角 キーを使用したい場合も mapper で他のキーに割り当ててくだ
さい。

　imgmount は 8G までのイメージファイルをマウントできますが、拡張 DOS 区画は使
用できず、基本 DOS 領域の 2G までしか使用できません。
　Vmware 等で作成したイメージファイルは、固定サイズかつ MBR が書き込まれている
状態であれば、オプション指定なしでマウント可能です。
　bximage で作成した 528M より大きいサイズのイメージファイルをマウントする場合、
通常通りに -size 512,63,16,cyl (cyl は cyl= で表示される値) と指定してください。
　bximage で作成した 2G 前後のサイズのイメージファイルをマウントして PC-DOS 等
をインストールする場合、ハードディスクの空き容量の一部を DOS に割り振るを選択
し、基本DOS 区画の作成の最大容量で作成しますかは N として手動でサイズを入力し
てください。割り当てを自動で行うと、小さいサイズで確保されてしまう可能性があり
ます。

　全角 16×16、全角 24×24 フォントに Windows のフォントを使用する場合、罫線は
内蔵のフォントデータを使用します。これは Windows フォントからデータを生成する
と罫線が繋がらないためです。

　autoreload=dos, all の場合、DOS ファンクション(int 21h)の ah=39h, 3ah, 3bh,
3dh, 4eh の実行前にディレクトリキャッシュの更新を行います。
　4eh(FindFirst) でも更新しますので、ファイル検索プログラム等で検索速度が低下
する可能性があります。

　Vz や Xscript によるコンソール出力の参照も可能です。
　LFN 対応版の Vz を使用する場合、バックアップファイルの作成のオプションは
OFF (Eb-) としてください。ON (Eb+) の場合、ロングファイルネームのファイルを保
存するとショートファイルネームで保存されてしまいます。

・AX モードでの注意事項
　AX モードで起動した場合、chev jp では AX 日本語モードとなります。
　DOS/V や J-3100 の日本語モードには切り替えできません。
　日本語キーボード対応や Windows IME での入力、Windows フォント使用等の機能は
AX モードにも反映しています。

・J-3100 モードでの注意事項
　J-3100 モードの場合、EMS のフレームセグメントは D000 となり、UMB は未使用と
なります。
　漢字 ROM からフォントデータを直接取得しているプログラムも動作します。
　スクロールはソフトウェアのみとなりますが、速度的には問題ないと思われます。
　RS-232C BIOS(int 14h) の ah=04h, 05h, 06h, 80h, 81h, 82h, 84h, 85h, 87h, f0h
は実装していません。
　キーボード BIOS(int 16h) の ah=f0h, f1h, f2h は実装していません。
　プリンタ BIOS(int 17h) の ah=84h, 85h は実装していません。
　J-3100 システム BIOS(int 60h) の ah=05h、ax=0f02h は実装していません。
　ATOK5 割り込み(int 6fh) には対応していますが、IME の ON/OFF や現在のモード
取得程度しか機能しません。ah=0fh, 10h, 11h, 12h は実装していません。
　東芝 MS-DOS のイメージファイルからのブートにも対応しています。
　その場合、キーボード配列は英語相当になりますのでご注意ください。
　漢字キーは Ctrl+F1 で呼び出される mapper 画面の Kanji にキーを割り当ててく
ださい。
　辞書 ROM やハードウェアによる EMS は使用できません。
　半角英数字が正しく表示されない場合、dosboxj.conf の [dosbox] debug=true と
してブートし、Windows の場合ダイアログ、Linux の場合コンソールに表示される
"font address XXXX" の XXXX の部分を dosboxj.confの [dosbox] j3sbcsaddress で
指定してください。

・DOS/V モードでの注意事項
　DOS/V モードで起動した場合、chev j3 で J-3100 モードに変更できません。
　対応している日本語での画面モードは、
　　03h: CGA テキスト互換モード
　　70h: V-Text モード
　　72h: VGA グラフィックスモード
　のみで、71h, 73h 等の拡張 CGA テキストモードには対応していません。
　vtext2 で指定する V-Text モードは設定時に 78h を指定していますが、画面変更
後は 70h となります。
　日本語フォントドライバは DOSVAXJ3 に内蔵しており、8×19, 8×16, 16×16,
12×24, 24×24 サイズのフォントが使用可能となっています。
　ビデオカード ET-4000 の設定の場合、dspVV は /hs=off として使用してください。
　ディスプレイ BIOS(int 10h) の ax=1311h, ax=1321h (拡張 CGA テキストモードの
文字列読み書き)には対応していません。
　キーボード BIOS(int 16h) ax=1300h では dl の bit 7 or Bit0 ON で IME ON、
bit 7 OFF で IME OFF となります。
　ax=1301h では IME OFF で dl=00h、IME ON で dl=81h を返します。
　ah=14h でシフト情報を表示に設定しても FEP 用のラインは確保されません。
　ディスクの直接読込(int 25h) に対応していないため、fd でファイル一覧が表示さ
れない場合はオプション -D をつけて起動してください。DOS バージョンが 7.1 以上
であれば fd は int 25h を使用しないようです。

●変更履歴
・build J31SS001 (2019/4/26)
　最初のバージョン

・build J31SS02E (2019/4/30)
　英語モードに切り替え可能としました。
　日本語メッセージを別ファイルとし、languagejp で指定するように変更しました。
　textcolor, backcolor の設定は j3100 での色指定に優先するように変更しました。

・build J31SX0VW (2019/5/5)
　DOS/V に対応しました。
　内蔵コマンド chev を追加し、日本語/英語/J-3100 の各モードへの切り替えができ
るようにしました。
　Wengier Wu 氏による DOSBox-lfn の修正を取り込み、ロングファイルネームや画面
上の文字のクリップボードへのコピー等に対応しました。
　textcolor, backcolor を j3textcolor, j3backcolor に変更しました。

・build J31SL0VW (2019/5/7)
　クリップボードから日本語文字列がペーストできなかったのを修正しました。
　DOS/V の $IAS.SYS のファンクションに対応しました。ただし FEP ON/OFF の設定や
取得程度しかできません。

・build JP190510 (2019/5/10)
　DOS ファンクションのファイル検索(ah=4eh, 4fh)で同時に異なる複数の検索を行っ
ている場合、正しく検索できていなかったのを修正しました。
　J-3100 モードでマウスドライバが有効になるよう修正しました。
　J-3100 モードのピクセル読み出し(int 10h ah=0dh)の不具合を修正しました。
　DOS/V モードでキーボードシフト情報(int 16h ah=14h)で状態保持を行うよう修正し
ました。
　ディレクトリキャッシュの自動更新オプション autoreload を追加しました。
　dir の表示中のみ Ctrl-C が効くようにしました。
　build 文字列を JP + 日付に変更しました。

・build JP190520 (2019/5/20)
　V-Text モードで XGA, SXGA に対応しました。
　V-Text のモードを二種類指定可能としました。
　Windows 版はデフォルトでステータスウインドウ非表示に変更しました。
　DOS/V での外字設定および表示に対応しました。
　設定項目に IM の有効無効を追加しました。
　Linux でビルド、実行できるようにしました。Ubuntu 18.04 で動作確認しています。
　DOSVAX build 4000AX12 の修正を取り込みました。

・build JP190523 (2019/5/23)
　Windows で MS-IME を使用していると、終了時に固まる場合があったのを修正しまし
た。
　ロングファイルネームのファイルが、ショートファイルネームを指定しないとオープ
ンできなくなっていたのを修正しました。JP190510 の複数検索対応によって発生して
いた不具合です。

・build JP190527 (2019/5/27)
　Windows で MS-IME を使用している場合に、キー入力が入りっぱなしになってしまう
現象の対策を行いました。
　J-3100 モードで起動した場合でも XGA, SXGA の V-Text モードを使用可能としまし
た。
　Linux でのクリップボードコピーに対応しました。ただし xclip をインストールし
ておく必要があります。
　Linux で Wayland を使用している場合にカーソルキーが正しく入力できなかったの
を修正しました。

・build JP190531 (2019/5/31)
　Windows IME の変換中文字列のフォントサイズを現在の V-Text のフォントサイズに
合わせました。jfontname が IME の変換中文字列のフォントの指定となります。
　ショートファイルネーム生成時に、漢字の 2 文字目に ~ が入ると文字化けしていた
のを修正しました。
　24×24 フォントの罫線データを内蔵しました。また、8×16、8×19 フォントの内蔵
罫線データのデザインを修正しています。

・build JP190621 (2019/6/21)
　ALT を押しながらのキー入力が効いていなかったのを修正しました。
　日本語キーボード対応処理を見直しました。スキャンコードが DOS/V と同じになる
ように変更しましたので、日本語キーボード設定の DOS/V のイメージからのブートで
もキーボードの表記通りで入力できます。
　keyboardlayout=jp の場合、Ctrl+F1 の mapper 画面も日本語キーボードの配列に
なるよう修正しました。
　J-3100 の漢字 ROM の直接読み出しに対応しました。
　J-3100 用の MS-DOS のイメージファイルを使用した場合にブートができなかったの
を修正しました。

・build JP190624 (2019/6/24)
　半角/全角キー押下時に ` が入ってしまっていたのを修正しました。
　日本語キーボードで右 Shift が使えるようにしました。

・build JP190710 (2019/7/10)
　EMS の set handle name (int 64h, ax=5301h) が正しく動作していなかったのを修
正しました。
　dir で日付表示がおかしかったのを修正しました。
　Windows でサイズが 2G を超えているファイルが imgmount で使用できなかったり、
mount したディレクトリ上の dir で表示されていなかったのを修正しました。
　英語モードでも疑似テキストバッファの取得 (int 10h ah=feh) でバッファアドレス
を返してしまっていたのを修正しました。
　拡張国別情報取得 (int 21h ax=6501h) がおかしな処理になっていたのを修正しまし
た。
　DOS/V のイメージファイルからブートして HDD のイメージファイルをフォーマット
するとエラーになっていたのを修正しました。

・build JP190820 (2019/8/20)
　imgmount で -t cdrom を指定した場合に落ちていたのを修正しました。
　上記の修正に伴い外字領域を最大 100 文字までに縮小しました。これは DOS の内部
ワーク領域が不足しているためです。
　Num Lock, Caps Lock ON で起動すると、入力が実際の Caps Lock, Num Lock の状態
と逆になっていたのを修正しました。
　imgmount で 8G までのイメージファイルをマウントできるよう修正しました。ただ
し使用可能なのは基本 DOS 領域の 2G までとなります。
　LFN が有効状態で FreeDOS の command.com を常駐させるとディレクトリ操作で暴走
してしまうのを修正しました。

●ライセンス
　GPL v2
　ソースコードや ABOUT_LIB、README_AX.txt も参照してください。

●最後に
　DOSBox, DOSVAX, DOSBox-lfn, SDL, libpng, zlib 等の作者の方々に感謝します。


                                                                      takapyu
